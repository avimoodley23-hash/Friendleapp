<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Friendle - Daily Puzzle Games</title>
    
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-MEASUREMENT-ID"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-MEASUREMENT-ID'); // Replace with your actual GA4 ID
    </script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .logo {
            font-size: 32px;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav-button, .auth-button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .nav-button {
            background: #f0f0f0;
            color: #333;
        }

        .nav-button:hover, .nav-button.active {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
        }

        .auth-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .auth-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        .content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            min-height: 500px;
        }

        .home-screen {
            text-align: center;
        }

        .game-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 40px;
        }

        .game-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 15px;
            color: white;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .game-card:hover {
            transform: translateY(-5px);
        }

        .game-card h3 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        /* Wordle Styles */
        .wordle-grid {
            display: grid;
            grid-template-rows: repeat(6, 1fr);
            gap: 5px;
            margin: 20px auto;
            max-width: 350px;
        }

        .wordle-row {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
        }

        .wordle-cell {
            width: 62px;
            height: 62px;
            border: 2px solid #d3d6da;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            text-transform: uppercase;
            border-radius: 4px;
        }

        .wordle-cell.filled {
            border-color: #878a8c;
        }

        .wordle-cell.correct {
            background: #6aaa64;
            border-color: #6aaa64;
            color: white;
        }

        .wordle-cell.present {
            background: #c9b458;
            border-color: #c9b458;
            color: white;
        }

        .wordle-cell.absent {
            background: #787c7e;
            border-color: #787c7e;
            color: white;
        }

        .keyboard {
            max-width: 500px;
            margin: 20px auto;
        }

        .keyboard-row {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin-bottom: 6px;
        }

        .key {
            padding: 15px;
            background: #d3d6da;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            min-width: 43px;
            transition: background 0.2s;
        }

        .key:hover {
            background: #b3b6ba;
        }

        .key.wide {
            min-width: 65px;
            font-size: 12px;
        }

        /* Connections Styles */
        .connections-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 20px 0;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .word-button {
            padding: 20px;
            background: #efefe6;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
        }

        .word-button:hover {
            background: #d3d3ca;
        }

        .word-button.selected {
            background: #5a594e;
            color: white;
        }

        .word-button.solved {
            cursor: default;
        }

        .solved-group {
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 10px;
            text-align: center;
            color: white;
            font-weight: 600;
        }

        .difficulty-1 { background: #f9df6d; color: #333; }
        .difficulty-2 { background: #a0c35a; }
        .difficulty-3 { background: #b0c4ef; }
        .difficulty-4 { background: #ba81c5; }

        /* Trivia Styles */
        .trivia-question {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .trivia-category {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            margin-bottom: 15px;
        }

        .trivia-answers {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .trivia-answer {
            padding: 15px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }

        .trivia-answer:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .trivia-answer.correct {
            background: #d4edda;
            border-color: #28a745;
        }

        .trivia-answer.incorrect {
            background: #f8d7da;
            border-color: #dc3545;
        }

        /* Leaderboard Styles */
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .leaderboard-table th,
        .leaderboard-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .leaderboard-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .leaderboard-table tr:hover {
            background: #f8f9ff;
        }

        .rank-medal {
            font-size: 20px;
            margin-right: 5px;
        }

        .game-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .game-button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .game-button.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .game-button.secondary {
            background: #f0f0f0;
            color: #333;
        }

        .game-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .game-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .message {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: 600;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
        }

        .message.info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #666;
        }

        /* Loading spinner animation */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-spinner {
            display: inline-block;
            font-size: 32px;
            animation: spin 2s linear infinite;
        }

        @media (max-width: 768px) {
            .wordle-cell {
                width: 52px;
                height: 52px;
                font-size: 24px;
            }

            .connections-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .game-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCndOWS881gWZO98ub8o_-tCdJMYiCgobg",
            authDomain: "friendle-1eef2.firebaseapp.com",
            projectId: "friendle-1eef2",
            storageBucket: "friendle-1eef2.firebasestorage.app",
            messagingSenderId: "413852218027",
            appId: "1:413852218027:web:889bc573b21255db08bdee",
            measurementId: "G-WH2523K0GB"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const analytics = firebase.analytics();

        // Analytics helper functions
        const logEvent = (eventName, params = {}) => {
            try {
                analytics.logEvent(eventName, params);
                console.log('Analytics event:', eventName, params);
            } catch (error) {
                console.error('Analytics error:', error);
            }
        };

        // ============================================
        // GEMINI AI INTEGRATION
        // ============================================
        
        // Your Gemini API key
        const GEMINI_API_KEY = "AIzaSyA5IAXSfFSdzmlrqoerhk4p30TrLvmSV4Y";
        const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent";

        // Get today's date as a string (YYYY-MM-DD)
        const getTodayDate = () => {
            const today = new Date();
            return today.toISOString().split('T')[0];
        };

        // Generate Wordle word using Gemini
        const generateWordleWord = async () => {
            if (GEMINI_API_KEY === "YOUR_GEMINI_API_KEY_HERE") {
                console.warn('Using fallback word - set your Gemini API key');
                return 'BRAIN';
            }

            try {
                logEvent('ai_generation_start', { type: 'wordle' });
                
                const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: "Generate a single common 5-letter English word suitable for a Wordle game. The word should be: 1) A common English word that most people know 2) Not a proper noun 3) Not offensive or inappropriate. Respond with ONLY the word in uppercase, nothing else. No explanations, no punctuation."
                            }]
                        }]
                    })
                });

                const data = await response.json();
                const word = data.candidates[0].content.parts[0].text.trim().toUpperCase();
                
                if (word.length === 5 && /^[A-Z]+$/.test(word)) {
                    logEvent('ai_generation_success', { type: 'wordle', word });
                    return word;
                }
                
                return 'BRAIN';
            } catch (error) {
                console.error('Error generating Wordle word:', error);
                logEvent('ai_generation_error', { type: 'wordle', error: error.message });
                return 'BRAIN';
            }
        };

        // Generate Connections puzzle using Gemini
        const generateConnectionsPuzzle = async () => {
            if (GEMINI_API_KEY === "YOUR_GEMINI_API_KEY_HERE") {
                console.warn('Using fallback puzzle - set your Gemini API key');
                return getFallbackConnections();
            }

            try {
                logEvent('ai_generation_start', { type: 'connections' });
                
                const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `Generate a Connections puzzle with 4 groups of 4 related words each. Return ONLY valid JSON in this exact format with no markdown, no explanations:
{
  "groups": [
    {"category": "Group Name 1", "words": ["WORD1", "WORD2", "WORD3", "WORD4"], "difficulty": 1},
    {"category": "Group Name 2", "words": ["WORD5", "WORD6", "WORD7", "WORD8"], "difficulty": 2},
    {"category": "Group Name 3", "words": ["WORD9", "WORD10", "WORD11", "WORD12"], "difficulty": 3},
    {"category": "Group Name 4", "words": ["WORD13", "WORD14", "WORD15", "WORD16"], "difficulty": 4}
  ]
}

Rules:
- Each word must be a single word in ALL CAPS
- Difficulty 1 is easiest, 4 is hardest
- Categories should be creative but clear
- Words should be common and recognizable
- No duplicates across groups`
                            }]
                        }]
                    })
                });

                const data = await response.json();
                const jsonText = data.candidates[0].content.parts[0].text.trim();
                const cleanJson = jsonText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                const puzzle = JSON.parse(cleanJson);
                
                logEvent('ai_generation_success', { type: 'connections' });
                return puzzle;
            } catch (error) {
                console.error('Error generating Connections puzzle:', error);
                logEvent('ai_generation_error', { type: 'connections', error: error.message });
                return getFallbackConnections();
            }
        };

        // Generate Trivia questions using Gemini
        const generateTriviaQuestions = async () => {
            if (GEMINI_API_KEY === "YOUR_GEMINI_API_KEY_HERE") {
                console.warn('Using fallback trivia - set your Gemini API key');
                return getFallbackTrivia();
            }

            try {
                logEvent('ai_generation_start', { type: 'trivia' });
                
                const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `Generate 10 trivia questions with 4 answer choices each. Return ONLY valid JSON in this exact format with no markdown:
{
  "questions": [
    {
      "category": "Science",
      "question": "What is the chemical symbol for gold?",
      "answers": ["Au", "Go", "Gd", "Ag"],
      "correct": 0
    }
  ]
}

Rules:
- Mix categories: Science, History, Geography, Sports, Entertainment, Literature, etc.
- Questions should be clear and factual
- One correct answer per question (index 0-3)
- Answers should be concise
- Moderate difficulty - not too easy, not too obscure
- Generate exactly 10 questions`
                            }]
                        }]
                    })
                });

                const data = await response.json();
                const jsonText = data.candidates[0].content.parts[0].text.trim();
                const cleanJson = jsonText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                const triviaData = JSON.parse(cleanJson);
                
                logEvent('ai_generation_success', { type: 'trivia' });
                return triviaData.questions;
            } catch (error) {
                console.error('Error generating Trivia questions:', error);
                logEvent('ai_generation_error', { type: 'trivia', error: error.message });
                return getFallbackTrivia();
            }
        };

        // Fallback puzzles
        const getFallbackConnections = () => ({
            groups: [
                { category: 'Primary Colors', words: ['RED', 'BLUE', 'YELLOW', 'GREEN'], difficulty: 1 },
                { category: 'Seasons', words: ['SPRING', 'SUMMER', 'FALL', 'WINTER'], difficulty: 2 },
                { category: 'Instruments', words: ['PIANO', 'GUITAR', 'DRUM', 'VIOLIN'], difficulty: 3 },
                { category: 'Languages', words: ['PYTHON', 'JAVA', 'RUBY', 'SWIFT'], difficulty: 4 },
            ]
        });

        const getFallbackTrivia = () => [
            { category: 'Science', question: 'What is the chemical symbol for gold?', answers: ['Au', 'Go', 'Gd', 'Ag'], correct: 0 },
            { category: 'History', question: 'In what year did World War II end?', answers: ['1943', '1944', '1945', '1946'], correct: 2 },
            { category: 'Geography', question: 'What is the capital of Australia?', answers: ['Sydney', 'Melbourne', 'Canberra', 'Brisbane'], correct: 2 },
            { category: 'Sports', question: 'How many players are on a basketball team?', answers: ['5', '6', '7', '11'], correct: 0 },
            { category: 'Science', question: 'What planet is known as the Red Planet?', answers: ['Venus', 'Mars', 'Jupiter', 'Saturn'], correct: 1 },
            { category: 'Entertainment', question: 'Who painted the Mona Lisa?', answers: ['Van Gogh', 'Picasso', 'Da Vinci', 'Monet'], correct: 2 },
            { category: 'Literature', question: 'Who wrote "Romeo and Juliet"?', answers: ['Dickens', 'Shakespeare', 'Austen', 'Tolkien'], correct: 1 },
            { category: 'Geography', question: 'What is the largest ocean?', answers: ['Atlantic', 'Indian', 'Arctic', 'Pacific'], correct: 3 },
            { category: 'Science', question: 'How many bones are in the human body?', answers: ['196', '206', '216', '226'], correct: 1 },
            { category: 'History', question: 'Who was the first US President?', answers: ['Jefferson', 'Adams', 'Washington', 'Lincoln'], correct: 2 }
        ];

        // Load or generate daily puzzles
        const loadDailyPuzzles = async () => {
            const today = getTodayDate();
            
            try {
                const puzzleDoc = await db.collection('dailyPuzzles').doc(today).get();
                
                if (puzzleDoc.exists) {
                    logEvent('puzzles_loaded', { source: 'firestore', date: today });
                    return puzzleDoc.data();
                } else {
                    console.log('Generating new puzzles for', today);
                    logEvent('puzzles_generation_started', { date: today });
                    
                    const [wordleWord, connectionsPuzzle, triviaQuestions] = await Promise.all([
                        generateWordleWord(),
                        generateConnectionsPuzzle(),
                        generateTriviaQuestions()
                    ]);
                    
                    const puzzles = {
                        date: today,
                        wordle: wordleWord,
                        connections: connectionsPuzzle,
                        trivia: triviaQuestions,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    await db.collection('dailyPuzzles').doc(today).set(puzzles);
                    logEvent('puzzles_generation_complete', { date: today });
                    
                    return puzzles;
                }
            } catch (error) {
                console.error('Error loading daily puzzles:', error);
                logEvent('puzzles_error', { error: error.message });
                return {
                    date: today,
                    wordle: 'BRAIN',
                    connections: getFallbackConnections(),
                    trivia: getFallbackTrivia()
                };
            }
        };

        // ============================================
        // COMPONENTS
        // ============================================

        // Home Screen Component
        function Home({ onSelectGame, user }) {
            useEffect(() => {
                logEvent('page_view', { page: 'home' });
            }, []);

            return (
                <div className="home-screen">
                    <h1 style={{ fontSize: '48px', marginBottom: '20px', color: '#667eea' }}>
                        Welcome to Friendle! üéÆ
                    </h1>
                    <p style={{ fontSize: '18px', color: '#666', marginBottom: '40px' }}>
                        {user ? `Hey ${user.displayName.split(' ')[0]}! ` : ''}
                        Challenge yourself with daily puzzles. New AI-generated puzzles every day!
                    </p>
                    <div className="game-grid">
                        <div className="game-card" onClick={() => {
                            logEvent('game_card_click', { game: 'wordle' });
                            onSelectGame('wordle');
                        }}>
                            <h3>üìù Wordle</h3>
                            <p>Guess the 5-letter word in 6 tries</p>
                        </div>
                        <div className="game-card" onClick={() => {
                            logEvent('game_card_click', { game: 'connections' });
                            onSelectGame('connections');
                        }}>
                            <h3>üîó Connections</h3>
                            <p>Find groups of 4 related words</p>
                        </div>
                        <div className="game-card" onClick={() => {
                            logEvent('game_card_click', { game: 'trivia' });
                            onSelectGame('trivia');
                        }}>
                            <h3>üß† Trivia</h3>
                            <p>Answer 10 trivia questions</p>
                        </div>
                    </div>
                </div>
            );
        }

        // Wordle Game Component
        function WordleGame({ user, dailyPuzzles }) {
            const WORD = dailyPuzzles?.wordle || 'BRAIN';
            const [guesses, setGuesses] = useState([]);
            const [currentGuess, setCurrentGuess] = useState('');
            const [gameOver, setGameOver] = useState(false);
            const [message, setMessage] = useState('');
            const [hasPlayed, setHasPlayed] = useState(false);

            useEffect(() => {
                logEvent('game_start', { game: 'wordle' });
                checkIfPlayedToday();
            }, [user]);

            const checkIfPlayedToday = async () => {
                if (!user) return;
                const userDoc = await db.collection('users').doc(user.uid).get();
                const userData = userDoc.data();
                const today = getTodayDate();
                
                if (userData?.stats?.wordle?.lastPlayed === today) {
                    setHasPlayed(true);
                    setMessage('You\'ve already played Wordle today! Come back tomorrow for a new puzzle. üéØ');
                }
            };

            const handleKeyPress = (key) => {
                if (gameOver || hasPlayed) return;

                if (key === 'ENTER') {
                    if (currentGuess.length === 5) {
                        submitGuess();
                    }
                } else if (key === 'BACK') {
                    setCurrentGuess(currentGuess.slice(0, -1));
                } else if (currentGuess.length < 5) {
                    setCurrentGuess(currentGuess + key);
                }
            };

            const submitGuess = async () => {
                const newGuesses = [...guesses, currentGuess];
                setGuesses(newGuesses);
                setCurrentGuess('');

                if (currentGuess === WORD) {
                    setGameOver(true);
                    setMessage('üéâ Congratulations! You won!');
                    logEvent('game_complete', { 
                        game: 'wordle', 
                        result: 'won', 
                        attempts: newGuesses.length 
                    });
                    if (user) await updateStats(true, newGuesses.length);
                } else if (newGuesses.length >= 6) {
                    setGameOver(true);
                    setMessage(`Game Over! The word was ${WORD}`);
                    logEvent('game_complete', { 
                        game: 'wordle', 
                        result: 'lost', 
                        attempts: newGuesses.length 
                    });
                    if (user) await updateStats(false, newGuesses.length);
                }
            };

            const updateStats = async (won, attempts) => {
                const today = getTodayDate();
                const userRef = db.collection('users').doc(user.uid);
                const userDoc = await userRef.get();
                const currentStats = userDoc.data()?.stats?.wordle || {};

                const newStreak = won && currentStats.lastPlayed === getYesterdayDate() 
                    ? (currentStats.streak || 0) + 1 
                    : won ? 1 : 0;

                await userRef.update({
                    'stats.wordle': {
                        played: (currentStats.played || 0) + 1,
                        won: (currentStats.won || 0) + (won ? 1 : 0),
                        streak: newStreak,
                        maxStreak: Math.max(newStreak, currentStats.maxStreak || 0),
                        lastPlayed: today
                    },
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
            };

            const getYesterdayDate = () => {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                return yesterday.toISOString().split('T')[0];
            };

            const getCellClass = (guess, index) => {
                if (!guess) return '';
                
                const letter = guess[index];
                if (letter === WORD[index]) return 'correct';
                if (WORD.includes(letter)) return 'present';
                return 'absent';
            };

            const rows = [];
            for (let i = 0; i < 6; i++) {
                const guess = guesses[i] || (i === guesses.length ? currentGuess : '');
                const isSubmitted = i < guesses.length;
                
                rows.push(
                    <div key={i} className="wordle-row">
                        {[0, 1, 2, 3, 4].map(j => (
                            <div 
                                key={j} 
                                className={`wordle-cell ${guess[j] ? 'filled' : ''} ${isSubmitted ? getCellClass(guess, j) : ''}`}
                            >
                                {guess[j] || ''}
                            </div>
                        ))}
                    </div>
                );
            }

            const keyboard = [
                ['Q', 'W', 'E', 'R', 'T', 'Y', 'U', 'I', 'O', 'P'],
                ['A', 'S', 'D', 'F', 'G', 'H', 'J', 'K', 'L'],
                ['ENTER', 'Z', 'X', 'C', 'V', 'B', 'N', 'M', 'BACK']
            ];

            if (!user) {
                return (
                    <div className="message info">
                        Please sign in to play Wordle! üîê
                    </div>
                );
            }

            return (
                <div>
                    <h2 style={{ textAlign: 'center', marginBottom: '20px' }}>Wordle üìù</h2>
                    {message && (
                        <div className={`message ${gameOver ? 'success' : 'info'}`}>
                            {message}
                        </div>
                    )}
                    <div className="wordle-grid">
                        {rows}
                    </div>
                    {!hasPlayed && !gameOver && (
                        <div className="keyboard">
                            {keyboard.map((row, i) => (
                                <div key={i} className="keyboard-row">
                                    {row.map(key => (
                                        <button
                                            key={key}
                                            className={`key ${key.length > 1 ? 'wide' : ''}`}
                                            onClick={() => handleKeyPress(key)}
                                        >
                                            {key}
                                        </button>
                                    ))}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        // Connections Game Component
        function ConnectionsGame({ user, dailyPuzzles }) {
            const puzzleData = dailyPuzzles?.connections || getFallbackConnections();

            const [words, setWords] = useState([]);
            const [selected, setSelected] = useState([]);
            const [solved, setSolved] = useState([]);
            const [message, setMessage] = useState('');
            const [hasPlayed, setHasPlayed] = useState(false);
            const [mistakes, setMistakes] = useState(0);
            const MAX_MISTAKES = 4;

            useEffect(() => {
                logEvent('game_start', { game: 'connections' });
                const allWords = puzzleData.groups.flatMap(g => g.words);
                setWords(allWords.sort(() => Math.random() - 0.5));
                checkIfPlayedToday();
            }, [user]);

            const checkIfPlayedToday = async () => {
                if (!user) return;
                const userDoc = await db.collection('users').doc(user.uid).get();
                const userData = userDoc.data();
                const today = getTodayDate();
                
                if (userData?.stats?.connections?.lastPlayed === today) {
                    setHasPlayed(true);
                    setMessage('You\'ve already played Connections today! Come back tomorrow. üîó');
                }
            };

            const toggleWord = (word) => {
                if (hasPlayed || solved.some(g => g.words.includes(word))) return;

                if (selected.includes(word)) {
                    setSelected(selected.filter(w => w !== word));
                } else if (selected.length < 4) {
                    setSelected([...selected, word]);
                }
            };

            const submitGuess = async () => {
                if (selected.length !== 4) return;

                logEvent('connections_guess', { 
                    words: selected,
                    mistakes: mistakes 
                });

                const matchedGroup = puzzleData.groups.find(group =>
                    selected.every(word => group.words.includes(word))
                );

                if (matchedGroup) {
                    setSolved([...solved, matchedGroup]);
                    setWords(words.filter(w => !selected.includes(w)));
                    setSelected([]);
                    setMessage('‚úÖ Correct!');

                    if (solved.length + 1 === puzzleData.groups.length) {
                        setMessage('üéâ You solved all groups!');
                        logEvent('game_complete', { 
                            game: 'connections', 
                            result: 'won',
                            mistakes: mistakes
                        });
                        if (user) await updateStats(true);
                    }
                } else {
                    const newMistakes = mistakes + 1;
                    setMistakes(newMistakes);
                    setSelected([]);
                    
                    if (newMistakes >= MAX_MISTAKES) {
                        setMessage('‚ùå Game Over! Out of attempts.');
                        logEvent('game_complete', { 
                            game: 'connections', 
                            result: 'lost',
                            mistakes: newMistakes
                        });
                        if (user) await updateStats(false);
                    } else {
                        setMessage(`‚ùå Not quite! ${MAX_MISTAKES - newMistakes} attempts left.`);
                    }
                }
            };

            const updateStats = async (won) => {
                const today = getTodayDate();
                const userRef = db.collection('users').doc(user.uid);
                const userDoc = await userRef.get();
                const currentStats = userDoc.data()?.stats?.connections || {};

                const getYesterdayDate = () => {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    return yesterday.toISOString().split('T')[0];
                };

                const newStreak = won && currentStats.lastPlayed === getYesterdayDate()
                    ? (currentStats.streak || 0) + 1
                    : won ? 1 : 0;

                await userRef.update({
                    'stats.connections': {
                        played: (currentStats.played || 0) + 1,
                        won: (currentStats.won || 0) + (won ? 1 : 0),
                        streak: newStreak,
                        maxStreak: Math.max(newStreak, currentStats.maxStreak || 0),
                        lastPlayed: today
                    },
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
            };

            if (!user) {
                return <div className="message info">Please sign in to play Connections! üîê</div>;
            }

            const isGameOver = hasPlayed || mistakes >= MAX_MISTAKES || solved.length === puzzleData.groups.length;

            return (
                <div>
                    <h2 style={{ textAlign: 'center', marginBottom: '20px' }}>Connections üîó</h2>
                    {message && (
                        <div className={`message ${message.includes('‚úÖ') || message.includes('üéâ') ? 'success' : message.includes('‚ùå') ? 'error' : 'info'}`}>
                            {message}
                        </div>
                    )}
                    
                    <div style={{ textAlign: 'center', marginBottom: '20px', fontSize: '18px' }}>
                        Mistakes remaining: {MAX_MISTAKES - mistakes}
                    </div>

                    {solved.map((group, i) => (
                        <div key={i} className={`solved-group difficulty-${group.difficulty}`}>
                            <div style={{ fontWeight: 'bold', marginBottom: '5px' }}>{group.category}</div>
                            <div>{group.words.join(', ')}</div>
                        </div>
                    ))}

                    {!isGameOver && (
                        <>
                            <div className="connections-grid">
                                {words.map((word, i) => (
                                    <button
                                        key={i}
                                        className={`word-button ${selected.includes(word) ? 'selected' : ''}`}
                                        onClick={() => toggleWord(word)}
                                    >
                                        {word}
                                    </button>
                                ))}
                            </div>

                            <div className="game-controls">
                                <button
                                    className="game-button secondary"
                                    onClick={() => setSelected([])}
                                    disabled={selected.length === 0}
                                >
                                    Deselect All
                                </button>
                                <button
                                    className="game-button primary"
                                    onClick={submitGuess}
                                    disabled={selected.length !== 4}
                                >
                                    Submit
                                </button>
                            </div>
                        </>
                    )}
                </div>
            );
        }

        // Trivia Game Component
        function TriviaGame({ user, dailyPuzzles }) {
            const triviaQuestions = dailyPuzzles?.trivia || getFallbackTrivia();
            const [currentQuestion, setCurrentQuestion] = useState(0);
            const [score, setScore] = useState(0);
            const [selectedAnswer, setSelectedAnswer] = useState(null);
            const [showResult, setShowResult] = useState(false);
            const [gameComplete, setGameComplete] = useState(false);
            const [hasPlayed, setHasPlayed] = useState(false);

            useEffect(() => {
                logEvent('game_start', { game: 'trivia' });
                checkIfPlayedToday();
            }, [user]);

            const checkIfPlayedToday = async () => {
                if (!user) return;
                const userDoc = await db.collection('users').doc(user.uid).get();
                const userData = userDoc.data();
                const today = getTodayDate();
                
                if (userData?.stats?.trivia?.lastPlayed === today) {
                    setHasPlayed(true);
                    setGameComplete(true);
                }
            };

            const handleAnswer = (index) => {
                if (showResult || hasPlayed) return;

                setSelectedAnswer(index);
                setShowResult(true);

                const isCorrect = index === triviaQuestions[currentQuestion].correct;
                
                logEvent('trivia_answer', {
                    question: currentQuestion + 1,
                    correct: isCorrect
                });

                if (isCorrect) {
                    setScore(score + 1);
                }
            };

            const nextQuestion = async () => {
                if (currentQuestion < triviaQuestions.length - 1) {
                    setCurrentQuestion(currentQuestion + 1);
                    setSelectedAnswer(null);
                    setShowResult(false);
                } else {
                    setGameComplete(true);
                    const finalScore = score + (selectedAnswer === triviaQuestions[currentQuestion].correct ? 1 : 0);
                    logEvent('game_complete', { 
                        game: 'trivia', 
                        score: finalScore,
                        total: triviaQuestions.length
                    });
                    if (user && !hasPlayed) await updateStats(finalScore);
                }
            };

            const updateStats = async (finalScore) => {
                const today = getTodayDate();
                const userRef = db.collection('users').doc(user.uid);
                const userDoc = await userRef.get();
                const currentStats = userDoc.data()?.stats?.trivia || {};

                await userRef.update({
                    'stats.trivia': {
                        played: (currentStats.played || 0) + 1,
                        totalScore: (currentStats.totalScore || 0) + finalScore,
                        perfectGames: (currentStats.perfectGames || 0) + (finalScore === 10 ? 1 : 0),
                        bestScore: Math.max(finalScore, currentStats.bestScore || 0),
                        lastPlayed: today
                    },
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
            };

            if (!user) {
                return <div className="message info">Please sign in to play Trivia! üîê</div>;
            }

            if (triviaQuestions.length === 0) {
                return <div className="loading">Loading trivia questions...</div>;
            }

            if (gameComplete) {
                return (
                    <div style={{ textAlign: 'center' }}>
                        <h2>üéâ Game Complete!</h2>
                        <div className="stat-value" style={{ margin: '20px 0' }}>
                            {hasPlayed ? 'Already Played Today' : `Score: ${score}/${triviaQuestions.length}`}
                        </div>
                        <p style={{ fontSize: '18px', color: '#666' }}>
                            {hasPlayed 
                                ? 'Come back tomorrow for new trivia questions!' 
                                : score === 10 ? 'üåü Perfect score! Amazing!' : score >= 7 ? 'Great job!' : 'Good effort! Try again tomorrow!'}
                        </p>
                    </div>
                );
            }

            const question = triviaQuestions[currentQuestion];

            return (
                <div>
                    <h2 style={{ textAlign: 'center', marginBottom: '20px' }}>Trivia üß†</h2>
                    <div style={{ textAlign: 'center', marginBottom: '20px', color: '#666' }}>
                        Question {currentQuestion + 1} of {triviaQuestions.length} | Score: {score}
                    </div>

                    <div className="trivia-question">
                        <span className="trivia-category">{question.category}</span>
                        <h3 style={{ fontSize: '22px', marginTop: '15px' }}>{question.question}</h3>

                        <div className="trivia-answers">
                            {question.answers.map((answer, index) => (
                                <button
                                    key={index}
                                    className={`trivia-answer ${
                                        showResult && index === question.correct ? 'correct' :
                                        showResult && index === selectedAnswer && index !== question.correct ? 'incorrect' : ''
                                    }`}
                                    onClick={() => handleAnswer(index)}
                                    disabled={showResult}
                                >
                                    {answer}
                                </button>
                            ))}
                        </div>
                    </div>

                    {showResult && (
                        <div className="game-controls">
                            <button className="game-button primary" onClick={nextQuestion}>
                                {currentQuestion < triviaQuestions.length - 1 ? 'Next Question' : 'Finish'}
                            </button>
                        </div>
                    )}
                </div>
            );
        }

        // Leaderboard Component
        function Leaderboard() {
            const [leaderboardData, setLeaderboardData] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                logEvent('page_view', { page: 'leaderboard' });
                loadLeaderboard();
            }, []);

            const loadLeaderboard = async () => {
                try {
                    const usersSnapshot = await db.collection('users').get();
                    const users = usersSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));

                    const leaderboard = users.map(user => {
                        const wordleWins = user.stats?.wordle?.won || 0;
                        const connectionsWins = user.stats?.connections?.won || 0;
                        const triviaScore = user.stats?.trivia?.totalScore || 0;
                        const totalScore = (wordleWins * 10) + (connectionsWins * 15) + triviaScore;

                        return {
                            name: user.displayName,
                            photoURL: user.photoURL,
                            wordleWins,
                            connectionsWins,
                            triviaScore,
                            totalScore
                        };
                    }).sort((a, b) => b.totalScore - a.totalScore);

                    setLeaderboardData(leaderboard);
                    setLoading(false);
                } catch (error) {
                    console.error('Error loading leaderboard:', error);
                    setLoading(false);
                }
            };

            const getMedal = (rank) => {
                if (rank === 0) return 'ü•á';
                if (rank === 1) return 'ü•à';
                if (rank === 2) return 'ü•â';
                return `${rank + 1}.`;
            };

            if (loading) {
                return <div className="loading"><span className="loading-spinner">üéÆ</span> Loading leaderboard...</div>;
            }

            return (
                <div>
                    <h2 style={{ textAlign: 'center', marginBottom: '20px' }}>üèÜ Leaderboard</h2>
                    <table className="leaderboard-table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Player</th>
                                <th>Wordle Wins</th>
                                <th>Connections Wins</th>
                                <th>Trivia Score</th>
                                <th>Total Score</th>
                            </tr>
                        </thead>
                        <tbody>
                            {leaderboardData.map((player, index) => (
                                <tr key={index}>
                                    <td>
                                        <span className="rank-medal">{getMedal(index)}</span>
                                    </td>
                                    <td>
                                        <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                            <img src={player.photoURL} alt={player.name} style={{ width: '32px', height: '32px', borderRadius: '50%' }} />
                                            {player.name}
                                        </div>
                                    </td>
                                    <td>{player.wordleWins}</td>
                                    <td>{player.connectionsWins}</td>
                                    <td>{player.triviaScore}</td>
                                    <td><strong>{player.totalScore}</strong></td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            );
        }

        // Profile Component
        function Profile({ user }) {
            const [stats, setStats] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                logEvent('page_view', { page: 'profile' });
                if (user) loadStats();
            }, [user]);

            const loadStats = async () => {
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    setStats(userDoc.data()?.stats || {});
                    setLoading(false);
                } catch (error) {
                    console.error('Error loading stats:', error);
                    setLoading(false);
                }
            };

            if (!user) {
                return <div className="message info">Please sign in to view your profile! üîê</div>;
            }

            if (loading) {
                return <div className="loading"><span className="loading-spinner">üéÆ</span> Loading profile...</div>;
            }

            return (
                <div>
                    <div style={{ textAlign: 'center', marginBottom: '30px' }}>
                        <img src={user.photoURL} alt={user.displayName} style={{ width: '100px', height: '100px', borderRadius: '50%', marginBottom: '15px' }} />
                        <h2>{user.displayName}</h2>
                        <p style={{ color: '#666' }}>{user.email}</p>
                    </div>

                    <h3 style={{ marginBottom: '20px' }}>üìä Your Stats</h3>

                    <h4 style={{ marginTop: '30px', marginBottom: '15px' }}>Wordle üìù</h4>
                    <div className="stats-grid">
                        <div className="stat-card">
                            <div className="stat-value">{stats.wordle?.played || 0}</div>
                            <div className="stat-label">Games Played</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-value">{stats.wordle?.won || 0}</div>
                            <div className="stat-label">Games Won</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-value">{stats.wordle?.streak || 0}</div>
                            <div className="stat-label">Current Streak</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-value">{stats.wordle?.maxStreak || 0}</div>
                            <div className="stat-label">Max Streak</div>
                        </div>
                    </div>

                    <h4 style={{ marginTop: '30px', marginBottom: '15px' }}>Connections üîó</h4>
                    <div className="stats-grid">
                        <div className="stat-card">
                            <div className="stat-value">{stats.connections?.played || 0}</div>
                            <div className="stat-label">Games Played</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-value">{stats.connections?.won || 0}</div>
                            <div className="stat-label">Games Won</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-value">{stats.connections?.streak || 0}</div>
                            <div className="stat-label">Current Streak</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-value">{stats.connections?.maxStreak || 0}</div>
                            <div className="stat-label">Max Streak</div>
                        </div>
                    </div>

                    <h4 style={{ marginTop: '30px', marginBottom: '15px' }}>Trivia üß†</h4>
                    <div className="stats-grid">
                        <div className="stat-card">
                            <div className="stat-value">{stats.trivia?.played || 0}</div>
                            <div className="stat-label">Games Played</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-value">{stats.trivia?.totalScore || 0}</div>
                            <div className="stat-label">Total Score</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-value">{stats.trivia?.perfectGames || 0}</div>
                            <div className="stat-label">Perfect Games</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-value">{stats.trivia?.bestScore || 0}</div>
                            <div className="stat-label">Best Score</div>
                        </div>
                    </div>
                </div>
            );
        }

        // Main App Component
        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [currentView, setCurrentView] = useState('home');
            const [dailyPuzzles, setDailyPuzzles] = useState(null);
            const [puzzlesLoading, setPuzzlesLoading] = useState(true);

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(async (user) => {
                    setUser(user);
                    setLoading(false);

                    if (user) {
                        logEvent('login', { method: 'google' });
                        
                        const userRef = db.collection('users').doc(user.uid);
                        const userDoc = await userRef.get();

                        if (!userDoc.exists) {
                            await userRef.set({
                                displayName: user.displayName,
                                email: user.email,
                                photoURL: user.photoURL,
                                stats: {
                                    wordle: { played: 0, won: 0, streak: 0, maxStreak: 0 },
                                    connections: { played: 0, won: 0, streak: 0, maxStreak: 0 },
                                    trivia: { played: 0, totalScore: 0, perfectGames: 0, bestScore: 0 }
                                },
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            logEvent('sign_up', { method: 'google' });
                        }
                    }
                });

                loadPuzzles();

                return () => unsubscribe();
            }, []);

            const loadPuzzles = async () => {
                setPuzzlesLoading(true);
                const puzzles = await loadDailyPuzzles();
                setDailyPuzzles(puzzles);
                setPuzzlesLoading(false);
            };

            const signInWithGoogle = async () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                try {
                    await auth.signInWithPopup(provider);
                } catch (error) {
                    console.error('Error signing in:', error);
                    logEvent('login_error', { error: error.message });
                }
            };

            const signOut = async () => {
                try {
                    logEvent('logout');
                    await auth.signOut();
                    setCurrentView('home');
                } catch (error) {
                    console.error('Error signing out:', error);
                }
            };

            if (loading || puzzlesLoading) {
                return (
                    <div className="app-container">
                        <div className="loading">
                            <span className="loading-spinner">üéÆ</span> Loading Friendle...
                        </div>
                    </div>
                );
            }

            return (
                <div className="app-container">
                    <div className="header">
                        <div className="logo">Friendle</div>
                        <div className="nav-buttons">
                            <button 
                                className={`nav-button ${currentView === 'home' ? 'active' : ''}`}
                                onClick={() => {
                                    logEvent('navigation', { page: 'home' });
                                    setCurrentView('home');
                                }}
                            >
                                Home
                            </button>
                            <button 
                                className={`nav-button ${currentView === 'leaderboard' ? 'active' : ''}`}
                                onClick={() => {
                                    logEvent('navigation', { page: 'leaderboard' });
                                    setCurrentView('leaderboard');
                                }}
                            >
                                Leaderboard
                            </button>
                            {user && (
                                <button 
                                    className={`nav-button ${currentView === 'profile' ? 'active' : ''}`}
                                    onClick={() => {
                                        logEvent('navigation', { page: 'profile' });
                                        setCurrentView('profile');
                                    }}
                                >
                                    Profile
                                </button>
                            )}
                        </div>
                        {user ? (
                            <div className="user-info">
                                <img src={user.photoURL} alt={user.displayName} className="user-avatar" />
                                <button className="auth-button" onClick={signOut}>
                                    Sign Out
                                </button>
                            </div>
                        ) : (
                            <button className="auth-button" onClick={signInWithGoogle}>
                                üîê Sign in with Google
                            </button>
                        )}
                    </div>

                    <div className="content">
                        {currentView === 'home' && <Home onSelectGame={setCurrentView} user={user} />}
                        {currentView === 'wordle' && <WordleGame user={user} dailyPuzzles={dailyPuzzles} />}
                        {currentView === 'connections' && <ConnectionsGame user={user} dailyPuzzles={dailyPuzzles} />}
                        {currentView === 'trivia' && <TriviaGame user={user} dailyPuzzles={dailyPuzzles} />}
                        {currentView === 'leaderboard' && <Leaderboard />}
                        {currentView === 'profile' && <Profile user={user} />}
                    </div>
                </div>
            );
        }

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
