<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Friendle - Daily Puzzles</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Lexend', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            color: #121213;
            overflow-x: hidden;
        }

        /* Neubrutalist Design System */
        :root {
            --border: 3px solid #121213;
            --shadow: 8px 8px 0px #121213;
            --shadow-small: 4px 4px 0px #121213;
            --radius: 0px;
            
            /* Game Colors */
            --connections: #e0bbff; /* Lilac */
            --wordle: #baffc9;      /* Mint */
            --crossword: #bae1ff;   /* Sky Blue */
            --spelling: #ffffba;    /* Honey */
            --trivia: #ffb3ba;      /* Salmon */
            
            /* UI Colors */
            --bg: #ffffff;
            --text: #121213;
            --muted: #666666;
            --success: #6aaa64;
            --warning: #c9b458;
            --error: #d32f2f;
        }

        /* Main App Container */
        .app {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            background: var(--bg);
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            padding: 20px 16px;
            border-bottom: var(--border);
            background: var(--bg);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 32px;
            font-weight: 800;
            letter-spacing: -1px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border: var(--border);
            border-radius: 50%;
            background: #ddd;
            overflow: hidden;
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .sign-in-btn {
            padding: 10px 16px;
            background: #121213;
            color: white;
            border: var(--border);
            box-shadow: var(--shadow-small);
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .sign-in-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #121213;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px 16px;
            padding-bottom: calc(88px + env(safe-area-inset-bottom, 0px));
        }

        /* Home Screen */
        .home-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 32px 20px;
        }

        .app-title {
            font-size: 48px;
            font-weight: 800;
            text-align: center;
            letter-spacing: -2px;
            margin-bottom: 8px;
        }

        .app-subtitle {
            font-size: 18px;
            text-align: center;
            color: var(--muted);
            font-weight: 500;
            margin-bottom: 32px;
        }

        /* Game Cards Grid */
        .games-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
        }

        .game-card {
            border: var(--border);
            box-shadow: var(--shadow);
            padding: 20px;
            cursor: pointer;
            transition: transform 0.1s;
            position: relative;
            overflow: hidden;
        }

        .game-card:active {
            transform: translate(4px, 4px);
            box-shadow: 4px 4px 0px #121213;
        }

        .game-card.connections { background: var(--connections); }
        .game-card.wordle { background: var(--wordle); }
        .game-card.crossword { background: var(--crossword); }
        .game-card.spelling { background: var(--spelling); }
        .game-card.trivia { background: var(--trivia); }

        .game-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .game-name {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 4px;
        }

        .game-icon {
            font-size: 32px;
        }

        .game-description {
            font-size: 14px;
            font-weight: 500;
            color: #333;
            margin-bottom: 16px;
            line-height: 1.4;
        }

        .game-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            font-weight: 600;
        }

        .streak {
            background: rgba(255, 255, 255, 0.7);
            padding: 4px 8px;
            border: 2px solid #121213;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 480px;
            background: var(--bg);
            border-top: var(--border);
            padding: 12px 24px calc(12px + env(safe-area-inset-bottom, 0px));
            display: flex;
            justify-content: space-around;
            z-index: 200;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .nav-item.active {
            background: #121213;
            color: white;
        }

        .nav-icon {
            font-size: 20px;
        }

        .nav-label {
            font-size: 10px;
            font-weight: 600;
        }

        /* Game Screens */
        .game-container {
            padding: clamp(18px, 4vw, 32px) clamp(14px, 4vw, 16px);
            background: var(--bg);
            min-height: calc(100vh - 200px);
        }

        .game-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .game-title {
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .game-subtitle {
            font-size: 14px;
            color: var(--muted);
            font-weight: 500;
        }

        /* Buttons */
        .button {
            padding: 14px 20px;
            border: var(--border);
            box-shadow: var(--shadow-small);
            background: var(--bg);
            font-family: inherit;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.1s;
            font-size: 14px;
        }

        .button:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #121213;
        }

        .button-primary {
            background: #121213;
            color: white;
        }

        .button-secondary {
            background: #f0f0f0;
        }

        /* Leaderboard */
        .leaderboard-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border: var(--border);
            box-shadow: var(--shadow-small);
            margin-bottom: 12px;
            background: var(--bg);
        }

        .leaderboard-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .rank {
            font-size: 18px;
            font-weight: 800;
            min-width: 32px;
        }

        .player-info h4 {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .player-info p {
            font-size: 12px;
            color: var(--muted);
            font-weight: 500;
        }

        .streak-info {
            text-align: right;
        }

        .streak-value {
            font-size: 18px;
            font-weight: 800;
        }

        .streak-label {
            font-size: 10px;
            color: var(--muted);
            font-weight: 600;
        }

        /* Wordle Grid */
                      /* Wordle hidden input for mobile keyboard */
                      .wordle-hidden-input {
                          position: absolute;
                          opacity: 0;
                          pointer-events: none;
                          height: 0;
                          width: 0;
                      }

                      .wordle-tap-area {
                          position: relative;
                          cursor: text;
                          -webkit-user-select: none;
                          user-select: none;
                      }

        .wordle-grid {
            display: grid;
            grid-template-rows: repeat(6, 1fr);
            gap: 8px;
            max-width: 350px;
            margin: 0 auto 24px;
        }

        .wordle-row {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }

        .wordle-cell {
            width: clamp(44px, 14vw, 56px); height: clamp(44px, 14vw, 56px); 
            border: var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(22px, 7vw, 32px); 
            font-weight: 800;
            background: var(--bg);
            transition: all 0.3s;
        }

        .wordle-cell.filled {
            background: #f0f0f0;
        }

        .wordle-cell.correct {
            background: var(--success);
            color: white;
        }

        .wordle-cell.present {
            background: var(--warning);
            color: white;
        }

        .wordle-cell.absent {
            background: #787c7e;
            color: white;
        }

        /* Connections Grid */
        .connections-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 24px;
        }

        .connections-word {
            padding: 8px;
            border: var(--border);
            background: #f0f0f0;
            font-size: 13px;
            font-weight: 700;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .connections-word.selected {
            background: #121213;
            color: white;
        }

        .connections-word.correct {
            background: var(--success);
            color: white;
        }

        /* Trivia */
        .trivia-question-card {
            border: var(--border);
            box-shadow: var(--shadow);
            padding: 32px 20px;
            margin-bottom: 24px;
            background: var(--trivia);
        }

        .trivia-category {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 12px;
        }

        .trivia-question {
            font-size: 20px;
            font-weight: 700;
            line-height: 1.3;
            margin-bottom: 20px;
        }

        .trivia-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .trivia-option {
            padding: 16px;
            border: var(--border);
            background: var(--bg);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .trivia-option:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #121213;
        }

        .trivia-option.correct {
            background: var(--success);
            color: white;
        }

        .trivia-option.incorrect {
            background: var(--error);
            color: white;
        }

        /* Toast Messages */
        .toast {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 16px 20px;
            border: var(--border);
            box-shadow: var(--shadow);
            background: var(--bg);
            font-weight: 600;
            z-index: 1000;
            max-width: 90%;
            text-align: center;
        }

        /* Loading Spinner */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f0f0f0;
            border-top: 4px solid #121213;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 380px) {
            .app-title {
                font-size: 40px;
            }
            
            .game-name {
                font-size: 20px;
            }
            
            .connections-word {
                font-size: 11px;
                padding: 6px;
            }
        }
        @media (max-width: 420px) {
            .home-container { padding: 28px 16px; }
            .app-title { font-size: 40px; }
            .game-title { font-size: 28px; }
            .connections-grid { gap: 6px; }
            .connections-word { font-size: 12px; padding: 6px; }
            .trivia-question { font-size: 18px; }
            .trivia-question-card { padding: 24px 16px; }
            .button-group { flex-direction: column; }
            .button { width: 100%; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- React and Firebase Scripts -->
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Analytics helper
        const logEvent = (eventName, params = {}) => {
            console.log('Event:', eventName, params);
        };

        // Helper: Get today's date string
        const getTodayString = () => {
            const today = new Date();
            return today.toISOString().split('T')[0];
        };

        // Helper: Check if played today
        const playedToday = (lastPlayed) => {
            return lastPlayed === getTodayString();
        };

        // Default daily puzzles
        const defaultPuzzles = {
            wordle: { word: "CHEESE" },
            connections: {
                words: [
                    "APPLE", "BANANA", "ORANGE", "GRAPE",
                    "CHAIR", "TABLE", "SOFA", "BED",
                    "RED", "BLUE", "GREEN", "YELLOW",
                    "DOG", "CAT", "BIRD", "FISH"
                ],
                categories: [
                    { name: "FRUITS", words: ["APPLE", "BANANA", "ORANGE", "GRAPE"] },
                    { name: "FURNITURE", words: ["CHAIR", "TABLE", "SOFA", "BED"] },
                    { name: "COLORS", words: ["RED", "BLUE", "GREEN", "YELLOW"] },
                    { name: "PETS", words: ["DOG", "CAT", "BIRD", "FISH"] }
                ]
            },
            trivia: [
                { category: "Food", question: "What is the main ingredient in guacamole?", options: ["Tomato", "Avocado", "Onion", "Pepper"], correct: 1 },
                { category: "Sports", question: "How many players are on a soccer team?", options: ["9", "10", "11", "12"], correct: 2 },
                { category: "Science", question: "What planet is known as the Red Planet?", options: ["Venus", "Mars", "Jupiter", "Saturn"], correct: 1 },
                { category: "Geography", question: "Which country has the largest population?", options: ["India", "USA", "China", "Russia"], correct: 2 },
                { category: "History", question: "Who was the first man on the moon?", options: ["Buzz Aldrin", "Neil Armstrong", "Yuri Gagarin", "John Glenn"], correct: 1 },
                { category: "Music", question: "Which instrument has 88 keys?", options: ["Guitar", "Piano", "Violin", "Drums"], correct: 1 },
                { category: "Movies", question: "Which movie features a character named 'Forrest Gump'?", options: ["Titanic", "Forrest Gump", "Avatar", "Inception"], correct: 1 },
                { category: "Animals", question: "What is the fastest land animal?", options: ["Lion", "Cheetah", "Horse", "Tiger"], correct: 1 },
                { category: "Math", question: "What is 7 √ó 8?", options: ["54", "56", "58", "60"], correct: 1 },
                { category: "Tech", question: "What does 'CPU' stand for?", options: ["Central Processing Unit", "Computer Power Unit", "Central Program Utility", "Core Processing Utility"], correct: 0 }
            ]
        };

        // Main App Component
        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [currentScreen, setCurrentScreen] = useState('home');
            const [toast, setToast] = useState(null);
            const [userStats, setUserStats] = useState(null);
            const [dailyPuzzles, setDailyPuzzles] = useState(defaultPuzzles);

            useEffect(() => {
                // Auth state listener
                const unsubscribe = auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        setUser(user);
                        await loadUserStats(user.uid);
                    } else {
                        setUser(null);
                        setUserStats(null);
                    }
                    setLoading(false);
                });

                // Load daily puzzles
                loadDailyPuzzles();

                return () => unsubscribe();
            }, []);

            const showToast = (message, duration = 3000) => {
                setToast(message);
                setTimeout(() => setToast(null), duration);
            };

            const loadUserStats = async (uid) => {
                try {
                    const userDoc = await db.collection('users').doc(uid).get();
                    
                    if (userDoc.exists) {
                        setUserStats(userDoc.data());
                    } else {
                        // Create new user profile
                        const newUserStats = {
                            displayName: user.displayName,
                            photoURL: user.photoURL,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            stats: {
                                wordle: { played: 0, won: 0, streak: 0, maxStreak: 0, lastPlayed: null },
                                connections: { played: 0, won: 0, streak: 0, maxStreak: 0, lastPlayed: null },
                                crossword: { played: 0, won: 0, streak: 0, maxStreak: 0, lastPlayed: null },
                                spelling: { played: 0, won: 0, streak: 0, maxStreak: 0, lastPlayed: null },
                                trivia: { played: 0, totalScore: 0, bestScore: 0, lastPlayed: null }
                            }
                        };

                        await db.collection('users').doc(uid).set(newUserStats);
                        setUserStats(newUserStats);
                    }
                } catch (error) {
                    console.error('Error loading user stats:', error);
                    showToast('Error loading your stats');
                }
            };

            const loadDailyPuzzles = async () => {
                try {
                    const today = getTodayString();
                    const puzzleDoc = await db.collection('dailyPuzzles').doc(today).get();
                    
                    if (puzzleDoc.exists) {
                        setDailyPuzzles(puzzleDoc.data());
                    } else {
                        // Use default puzzles if none exist
                        setDailyPuzzles(defaultPuzzles);
                    }
                } catch (error) {
                    console.error('Error loading daily puzzles:', error);
                    setDailyPuzzles(defaultPuzzles);
                }
            };

            const signInWithGoogle = async () => {
                try {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    await auth.signInWithPopup(provider);
                    logEvent('sign_in');
                } catch (error) {
                    console.error('Sign in error:', error);
                    showToast('Error signing in');
                }
            };

            const signOut = async () => {
                try {
                    await auth.signOut();
                    setCurrentScreen('home');
                    showToast('Signed out');
                } catch (error) {
                    console.error('Sign out error:', error);
                }
            };

            const updateGameStats = async (game, won, score = null) => {
                if (!user || !userStats) return;

                try {
                    const today = getTodayString();
                    const updatedStats = { ...userStats };
                    const gameStats = updatedStats.stats[game];

                    if (game === 'trivia') {
                        // Trivia uses score system
                        gameStats.played += 1;
                        gameStats.totalScore += score;
                        gameStats.bestScore = Math.max(gameStats.bestScore, score);
                        gameStats.lastPlayed = today;
                    } else {
                        // Other games use win/loss system
                        gameStats.played += 1;
                        if (won) {
                            gameStats.won += 1;
                            gameStats.streak += 1;
                            gameStats.maxStreak = Math.max(gameStats.maxStreak, gameStats.streak);
                        } else {
                            gameStats.streak = 0;
                        }
                        gameStats.lastPlayed = today;
                    }

                    // Update Firestore
                    await db.collection('users').doc(user.uid).update({
                        [`stats.${game}`]: gameStats
                    });

                    setUserStats(updatedStats);
                } catch (error) {
                    console.error('Error updating stats:', error);
                    showToast('Error saving your score');
                }
            };

            if (loading) {
                return (
                    <div className="app">
                        <div className="loading">
                            <div className="spinner"></div>
                            <p>Loading Friendle...</p>
                        </div>
                    </div>
                );
            }

            const renderScreen = () => {
                switch (currentScreen) {
                    case 'home':
                        return <HomeScreen user={user} userStats={userStats} onNavigate={setCurrentScreen} onSignIn={signInWithGoogle} />;
                    case 'wordle':
                        return <WordleGame user={user} userStats={userStats} onUpdateStats={updateGameStats} dailyPuzzles={dailyPuzzles} />;
                    case 'connections':
                        return <ConnectionsGame user={user} userStats={userStats} onUpdateStats={updateGameStats} dailyPuzzles={dailyPuzzles} />;
                    case 'trivia':
                        return <TriviaGame user={user} userStats={userStats} onUpdateStats={updateGameStats} dailyPuzzles={dailyPuzzles} />;
                    case 'leaderboard':
                        return <Leaderboard user={user} />;
                    default:
                        return <HomeScreen user={user} userStats={userStats} onNavigate={setCurrentScreen} onSignIn={signInWithGoogle} />;
                }
            };

            return (
                <div className="app">
                    <Header user={user} onSignIn={signInWithGoogle} onSignOut={signOut} />
                    
                    <div className="main-content">
                        {renderScreen()}
                    </div>

                    {user && (
                        <BottomNav currentScreen={currentScreen} onNavigate={setCurrentScreen} />
                    )}

                    {toast && <div className="toast">{toast}</div>}
                </div>
            );
        }

        // Header Component
        function Header({ user, onSignIn, onSignOut }) {
            return (
                <div className="header">
                    <div className="header-content">
                        <div className="logo">Friendle</div>
                        <div className="user-info">
                            {user ? (
                                <>
                                    <div className="avatar">
                                        <img src={user.photoURL} alt={user.displayName} />
                                    </div>
                                    <button className="sign-in-btn" onClick={onSignOut}>
                                        Sign Out
                                    </button>
                                </>
                            ) : (
                                <button className="sign-in-btn" onClick={onSignIn}>
                                    Sign In
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // Bottom Navigation Component
        function BottomNav({ currentScreen, onNavigate }) {
            const navItems = [
                { id: 'home', icon: 'üè†', label: 'Home' },
                { id: 'leaderboard', icon: 'üèÜ', label: 'Leaders' }
            ];

            return (
                <div className="bottom-nav">
                    {navItems.map(item => (
                        <div
                            key={item.id}
                            className={`nav-item ${currentScreen === item.id ? 'active' : ''}`}
                            onClick={() => onNavigate(item.id)}
                        >
                            <div className="nav-icon">{item.icon}</div>
                            <div className="nav-label">{item.label}</div>
                        </div>
                    ))}
                </div>
            );
        }

        // Home Screen Component
        function HomeScreen({ user, userStats, onNavigate, onSignIn }) {
            const games = [
                {
                    id: 'connections',
                    name: 'Connections',
                    icon: 'üîó',
                    description: 'Group words into 4 categories',
                    color: 'connections'
                },
                {
                    id: 'wordle',
                    name: 'Wordle',
                    icon: 'üü©',
                    description: 'Guess the 5-letter word in 6 tries',
                    color: 'wordle'
                },
                {
                    id: 'trivia',
                    name: 'Daily Trivia',
                    icon: 'üß†',
                    description: 'Answer 10 questions, test your knowledge',
                    color: 'trivia'
                }
            ];

            if (!user) {
                return (
                    <div className="home-container">
                        <h1 className="app-title">Friendle</h1>
                        <p className="app-subtitle">Daily puzzles for friends & family</p>
                        
                        <div style={{ textAlign: 'center' }}>
                            <button className="button button-primary" onClick={onSignIn}>
                                Sign In to Play
                            </button>
                        </div>
                    </div>
                );
            }

            const getGameStreak = (gameId) => {
                return userStats?.stats?.[gameId]?.streak || 0;
            };

            return (
                <div className="home-container">
                    <h1 className="app-title">Friendle</h1>
                    <p className="app-subtitle">Daily puzzles for friends & family</p>
                    
                    <div className="games-grid">
                        {games.map(game => (
                            <div
                                key={game.id}
                                className={`game-card ${game.color}`}
                                onClick={() => onNavigate(game.id)}
                            >
                                <div className="game-card-header">
                                    <div>
                                        <h3 className="game-name">{game.name}</h3>
                                        <p className="game-description">{game.description}</p>
                                    </div>
                                    <div className="game-icon">{game.icon}</div>
                                </div>
                                
                                <div className="game-stats">
                                    <span>Tap to play</span>
                                    <span className="streak">üî• {getGameStreak(game.id)}</span>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        // Wordle Game Component
        function WordleGame({ user, userStats, onUpdateStats, dailyPuzzles }) {
            const WORD = dailyPuzzles?.wordle?.word || "FRIEND";
            const [guesses, setGuesses] = useState(Array(6).fill(''));
            const [currentGuess, setCurrentGuess] = useState('');
            const [gameOver, setGameOver] = useState(false);
            const [message, setMessage] = useState('');
            const [shake, setShake] = useState(false);
            const maxGuesses = 6;

            const inputRef = useRef(null);

            const wordleStats = userStats?.stats?.wordle;
            const alreadyPlayed = playedToday(wordleStats?.lastPlayed);

            useEffect(() => {
                logEvent('wordle_view');
                
                if (alreadyPlayed) {
                    setGameOver(true);
                    setMessage('Come back tomorrow for a new word!');
                }
            }, []);

            useEffect(() => {
                if (gameOver || !user) return;

                // Auto-focus on mobile so the on-screen keyboard appears
                const t = setTimeout(() => {
                    try { inputRef.current && inputRef.current.focus(); } catch (e) {}
                }, 50);

                const handleKeyPress = (e) => {
                    // Avoid double-handling when the hidden input is focused
                    const active = document.activeElement;
                    if (active === inputRef.current) return;

                    if (e.key === 'Enter') {
                        submitGuess();
                    } else if (e.key === 'Backspace') {
                        setCurrentGuess(prev => prev.slice(0, -1));
                    } else if (/^[a-zA-Z]$/.test(e.key) && currentGuess.length < 5) {
                        setCurrentGuess(prev => (prev + e.key.toUpperCase()).slice(0, 5));
                    }
                };

                window.addEventListener('keydown', handleKeyPress);
                return () => {
                    clearTimeout(t);
                    window.removeEventListener('keydown', handleKeyPress);
                };
            }, [currentGuess, gameOver, user]);

            const submitGuess = () => {
                if (currentGuess.length !== 5) {
                    setMessage('Word must be 5 letters!');
                    setShake(true);
                    setTimeout(() => setShake(false), 500);
                    return;
                }

                const guessIndex = guesses.findIndex(g => g === '');
                if (guessIndex === -1) return;

                const newGuesses = [...guesses];
                newGuesses[guessIndex] = currentGuess;
                setGuesses(newGuesses);

                // Check win condition
                if (currentGuess === WORD) {
                    setGameOver(true);
                    setMessage('üéâ You got it!');
                    onUpdateStats('wordle', true);
                } else if (guessIndex === maxGuesses - 1) {
                    setGameOver(true);
                    setMessage(`Game over! The word was ${WORD}`);
                    onUpdateStats('wordle', false);
                }

                setCurrentGuess('');
            };

            const getCellClass = (letter, rowIndex, colIndex) => {
                if (!letter) return '';
                
                const guess = guesses[rowIndex];
                if (!guess) return 'filled';

                const targetLetter = WORD[colIndex];
                if (letter === targetLetter) return 'correct';
                if (WORD.includes(letter)) return 'present';
                return 'absent';
            };

            const renderGrid = () => {
                return guesses.map((guess, rowIndex) => {
                    const isCurrentRow = rowIndex === guesses.findIndex(g => g === '');
                    const rowLetters = isCurrentRow ? currentGuess.padEnd(5, ' ') : guess.padEnd(5, ' ');

                    return (
                        <div key={rowIndex} className={`wordle-row ${shake && isCurrentRow ? 'shake' : ''}`}>
                            {rowLetters.split('').map((letter, colIndex) => (
                                <div
                                    key={colIndex}
                                    className={`wordle-cell ${getCellClass(letter.trim(), rowIndex, colIndex)}`}
                                >
                                    {letter.trim()}
                                </div>
                            ))}
                        </div>
                    );
                });
            };

            if (alreadyPlayed) {
                return (
                    <div className="game-container">
                        <div className="game-header">
                            <h2 className="game-title">Wordle</h2>
                            <p className="game-subtitle">You already played today!</p>
                        </div>
                        <div style={{ textAlign: 'center', padding: '40px' }}>
                            <p style={{ fontSize: '18px', marginBottom: '20px' }}>Come back tomorrow!</p>
                            <p>The word was: <strong>{WORD}</strong></p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="game-container">
                    <div className="game-header">
                        <h2 className="game-title">Wordle</h2>
                        <p className="game-subtitle">Guess the word in 6 tries</p>
                    </div>

                    <div className="wordle-tap-area" onClick={() => {
                        try { inputRef.current && inputRef.current.focus(); } catch (e) {}
                    }}>
                        <input
                            ref={inputRef}
                            className="wordle-hidden-input"
                            type="text"
                            inputMode="text"
                            autoComplete="off"
                            autoCorrect="off"
                            autoCapitalize="characters"
                            spellCheck="false"
                            value={currentGuess}
                            onChange={(e) => {
                                const v = (e.target.value || '').toUpperCase().replace(/[^A-Z]/g, '').slice(0, 5);
                                setCurrentGuess(v);
                            }}
                            onKeyDown={(e) => {
                                if (e.key === 'Enter') {
                                    e.preventDefault();
                                    submitGuess();
                                }
                            }}
                        />
                        <div className="wordle-grid">
                            {renderGrid()}
                        </div>
                    </div>

                    {message && (
                        <div style={{ textAlign: 'center', marginBottom: '20px', fontWeight: '600' }}>
                            {message}
                        </div>
                    )}

                    {!gameOver && (
                        <div style={{ textAlign: 'center' }}>
                            <button className="button button-primary" onClick={submitGuess}>
                                Submit
                            </button>
                        </div>
                    )}
                </div>
            );
        }

        // Connections Game Component
        function ConnectionsGame({ user, userStats, onUpdateStats, dailyPuzzles }) {
            const puzzle = dailyPuzzles?.connections || defaultPuzzles.connections;
            const [words, setWords] = useState([...puzzle.words].sort(() => Math.random() - 0.5));
            const [selected, setSelected] = useState([]);
            const [solved, setSolved] = useState([]);
            const [gameOver, setGameOver] = useState(false);
            const [message, setMessage] = useState('');

            const connectionsStats = userStats?.stats?.connections;
            const alreadyPlayed = playedToday(connectionsStats?.lastPlayed);

            useEffect(() => {
                logEvent('connections_view');
                
                if (alreadyPlayed) {
                    setGameOver(true);
                    setMessage('Come back tomorrow for new connections!');
                }
            }, []);

            const toggleWord = (word) => {
                if (gameOver || alreadyPlayed) return;

                if (selected.includes(word)) {
                    setSelected(selected.filter(w => w !== word));
                } else if (selected.length < 4) {
                    setSelected([...selected, word]);
                }
            };

            const checkSelection = () => {
                if (selected.length !== 4) return;

                const category = puzzle.categories.find(cat => 
                    cat.words.every(w => selected.includes(w))
                );

                if (category) {
                    setSolved([...solved, category]);
                    setWords(words.filter(w => !selected.includes(w)));
                    setSelected([]);
                    setMessage(`‚úÖ ${category.name}!`);

                    if (solved.length === 3) {
                        setGameOver(true);
                        setMessage('üéâ You solved them all!');
                        onUpdateStats('connections', true);
                    }
                } else {
                    setMessage('‚ùå Not a category, try again!');
                    setSelected([]);
                }
            };

            if (alreadyPlayed) {
                return (
                    <div className="game-container">
                        <div className="game-header">
                            <h2 className="game-title">Connections</h2>
                            <p className="game-subtitle">You already played today!</p>
                        </div>
                        <div style={{ textAlign: 'center', padding: '40px' }}>
                            <p style={{ fontSize: '18px', marginBottom: '20px' }}>Come back tomorrow!</p>
                            <p>You can view tomorrow's puzzle then.</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="game-container">
                    <div className="game-header">
                        <h2 className="game-title">Connections</h2>
                        <p className="game-subtitle">Group words into 4 categories</p>
                    </div>

                    <div className="connections-grid">
                        {words.map(word => (
                            <div
                                key={word}
                                className={`connections-word ${selected.includes(word) ? 'selected' : ''}`}
                                onClick={() => toggleWord(word)}
                            >
                                {word}
                            </div>
                        ))}
                    </div>

                    {message && (
                        <div style={{ textAlign: 'center', marginBottom: '20px', fontWeight: '600' }}>
                            {message}
                        </div>
                    )}

                    {!gameOver && (
                        <div style={{ textAlign: 'center', display: 'flex', gap: '12px', justifyContent: 'center' }}>
                            <button 
                                className="button button-secondary"
                                onClick={() => setSelected([])}
                            >
                                Clear
                            </button>
                            <button 
                                className="button button-primary"
                                onClick={checkSelection}
                                disabled={selected.length !== 4}
                                style={{ opacity: selected.length === 4 ? 1 : 0.5 }}
                            >
                                Submit
                            </button>
                        </div>
                    )}
                </div>
            );
        }

        // Trivia Game Component
        function TriviaGame({ user, userStats, onUpdateStats, dailyPuzzles }) {
            const triviaQuestions = dailyPuzzles?. trivia || [
                { category: "Science", question: "What is the chemical symbol for gold?", options: ["Au", "Go", "Gd", "Ag"], correct: 0 },
                { category: "Geography", question: "What is the capital of Australia?", options: ["Sydney", "Melbourne", "Canberra", "Brisbane"], correct: 2 },
                { category: "History", question: "In which year did World War II end?", options: ["1943", "1944", "1945", "1946"], correct: 2 },
                { category: "Literature", question: "Who wrote \"To Kill a Mockingbird\"?", options: ["Harper Lee", "Mark Twain", "John Steinbeck", "Ernest Hemingway"], correct: 0 },
                { category: "Science", question: "What is the largest planet in our solar system?", options: ["Saturn", "Neptune", "Jupiter", "Uranus"], correct: 2 },
                { category: "Entertainment", question: "Which movie won Best Picture in 1994?", options: ["Pulp Fiction", "Forrest Gump", "Shawshank", "Lion King"], correct: 1 },
                { category: "Sports", question: "How many players on a basketball team on court?", options: ["4", "5", "6", "7"], correct: 1 },
                { category: "Geography", question: "What is the longest river in the world?", options: ["Amazon", "Nile", "Yangtze", "Mississippi"], correct: 1 },
                { category: "Science", question: "What is the speed of light?", options: ["299,792 km/s", "199,792 km/s", "399,792 km/s", "99,792 km/s"], correct: 0 },
                { category: "History", question: "First President of the United States?", options: ["Jefferson", "Adams", "Washington", "Franklin"], correct: 2 }
            ];
            const fallbackQuestions = triviaQuestions;
            const ensureTenQuestions = (qs) => {
                const base = Array.isArray(qs) ? qs : [];
                if (base.length >= 10) return base.slice(0, 10);
                // Pad with defaults so the game always has 10 questions
                const padded = base.concat([
                    { category: 'Science', question: 'What is the chemical symbol for gold?', options: ['Au', 'Go', 'Gd', 'Ag'], correct: 0 },
                    { category: 'Geography', question: 'What is the capital of Australia?', options: ['Sydney', 'Melbourne', 'Canberra', 'Brisbane'], correct: 2 },
                    { category: 'History', question: 'In which year did World War II end?', options: ['1943', '1944', '1945', '1946'], correct: 2 },
                    { category: 'Literature', question: 'Who wrote "To Kill a Mockingbird"?', options: ['Harper Lee', 'Mark Twain', 'John Steinbeck', 'Ernest Hemingway'], correct: 0 },
                    { category: 'Science', question: 'What is the largest planet in our solar system?', options: ['Saturn', 'Neptune', 'Jupiter', 'Uranus'], correct: 2 },
                    { category: 'Entertainment', question: 'Which movie won Best Picture in 1994?', options: ['Pulp Fiction', 'Forrest Gump', 'Shawshank', 'Lion King'], correct: 1 },
                    { category: 'Sports', question: 'How many players on a basketball team on court?', options: ['4', '5', '6', '7'], correct: 1 },
                    { category: 'Geography', question: 'What is the longest river in the world?', options: ['Amazon', 'Nile', 'Yangtze', 'Mississippi'], correct: 1 },
                    { category: 'Science', question: 'What is the speed of light?', options: ['299,792 km/s', '199,792 km/s', '399,792 km/s', '99,792 km/s'], correct: 0 },
                    { category: 'History', question: 'First President of the United States?', options: ['Jefferson', 'Adams', 'Washington', 'Franklin'], correct: 2 }
                ]);
                return padded.slice(0, 10);
            };

            const questions = ensureTenQuestions(dailyPuzzles?.trivia || fallbackQuestions);

            const [currentQuestion, setCurrentQuestion] = useState(0);
            const [score, setScore] = useState(0);
            const scoreRef = useRef(0);

            const [selectedAnswer, setSelectedAnswer] = useState(null);
            const [answered, setAnswered] = useState(false);
            const [gameOver, setGameOver] = useState(false);

            useEffect(() => { scoreRef.current = score; }, [score]);
            const triviaStats = userStats?.stats?.trivia;
            const alreadyPlayed = playedToday(triviaStats?.lastPlayed);

            useEffect(() => {
                logEvent('trivia_view');
                
                if (alreadyPlayed) {
                    setGameOver(true);
                }
            }, []);

            const handleAnswerClick = (index) => {
                if (answered) return;

                setSelectedAnswer(index);
                setAnswered(true);

                if (index === questions[currentQuestion].correct) {
                    setScore(prev => prev + 1);
                }
            };

            const handleNext = () => {
                if (currentQuestion < 9) {
                    setCurrentQuestion(currentQuestion + 1);
                    setSelectedAnswer(null);
                    setAnswered(false);
                } else {
                    setGameOver(true);
                    onUpdateStats('trivia', true, scoreRef.current);
                }
            };

            if (alreadyPlayed) {
                return (
                    <div className="game-container">
                        <div className="game-header">
                            <h2 className="game-title">Daily Trivia</h2>
                            <p className="game-subtitle">You already played today!</p>
                        </div>
                        <div style={{ textAlign: 'center', padding: '40px' }}>
                            <p style={{ fontSize: '18px', marginBottom: '20px' }}>Come back tomorrow!</p>
                            <p>Your best score: <strong>{triviaStats?.bestScore || 0}/10</strong></p>
                        </div>
                    </div>
                );
            }

            if (gameOver) {
                return (
                    <div className="game-container">
                        <div className="game-header">
                            <h2 className="game-title">Daily Trivia</h2>
                            <p className="game-subtitle">Game Complete!</p>
                        </div>
                        <div style={{ textAlign: 'center', padding: '40px' }}>
                            <p style={{ fontSize: '32px', fontWeight: '800', marginBottom: '16px' }}>
                                {score}/10
                            </p>
                            <p style={{ fontSize: '18px', marginBottom: '20px' }}>
                                {score >= 8 ? 'üéâ Amazing!' : score >= 6 ? 'üëç Good job!' : 'üí™ Try again tomorrow!'}
                            </p>
                            <p>Come back tomorrow for new questions!</p>
                        </div>
                    </div>
                );
            }

            const question = questions[currentQuestion];

            return (
                <div className="game-container">
                    <div className="game-header">
                        <h2 className="game-title">Daily Trivia</h2>
                        <p className="game-subtitle">Question {currentQuestion + 1} of 10</p>
                    </div>

                    <div className="trivia-question-card">
                        <div className="trivia-category">{question.category}</div>
                        <div className="trivia-question">{question.question}</div>
                        
                        <div className="trivia-options">
                            {question.options.map((option, index) => {
                                let className = 'trivia-option';
                                
                                if (answered) {
                                    if (index === question.correct) {
                                        className += ' correct';
                                    } else if (index === selectedAnswer) {
                                        className += ' incorrect';
                                    }
                                }

                                return (
                                    <div
                                        key={index}
                                        className={className}
                                        onClick={() => handleAnswerClick(index)}
                                    >
                                        {option}
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    {answered && (
                        <div style={{ textAlign: 'center' }}>
                            <button className="button button-primary" onClick={handleNext}>
                                {currentQuestion < 9 ? 'Next Question' : 'Finish'}
                            </button>
                        </div>
                    )}
                </div>
            );
        }

        // Leaderboard Component
        function Leaderboard({ user }) {
            const [players, setPlayers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [activeGame, setActiveGame] = useState('wordle'); // wordle | connections | trivia | overall

            useEffect(() => {
                logEvent('leaderboard_view');
                loadLeaderboard();
            }, []);

            const loadLeaderboard = async () => {
                try {
                    setLoading(true);
                    const snapshot = await db.collection('users').get();
                    const entries = snapshot.docs.map(doc => {
                        const data = doc.data();
                        const wordle = data.stats?.wordle || { played: 0, won: 0 };
                        const connections = data.stats?.connections || { played: 0, won: 0 };
                        const trivia = data.stats?.trivia || { played: 0, totalScore: 0, bestScore: 0 };

                        const wordleWinRate = wordle.played > 0 ? Math.round((wordle.won / wordle.played) * 100) : 0;
                        const connectionsWinRate = connections.played > 0 ? Math.round((connections.won / connections.played) * 100) : 0;
                        const triviaAvg = trivia.played > 0 ? Math.round((trivia.totalScore / trivia.played / 10) * 100) : 0; // percent
                        const triviaBest = trivia.bestScore || 0;

                        const overallScore = Math.round((wordleWinRate + connectionsWinRate + triviaAvg) / 3);

                        return {
                            uid: doc.id,
                            displayName: data.displayName || 'Anonymous',
                            photoURL: data.photoURL || null,
                            wordleWinRate,
                            connectionsWinRate,
                            triviaAvg,
                            triviaBest,
                            overallScore,
                            // helpful tie-breakers
                            wordlePlayed: wordle.played || 0,
                            connectionsPlayed: connections.played || 0,
                            triviaPlayed: trivia.played || 0
                        };
                    });

                    setPlayers(entries);
                    setLoading(false);
                } catch (error) {
                    console.error('Error loading leaderboard:', error);
                    setLoading(false);
                }
            };

            const sorted = [...players].sort((a, b) => {
                if (activeGame === 'wordle') {
                    if (b.wordleWinRate !== a.wordleWinRate) return b.wordleWinRate - a.wordleWinRate;
                    return b.wordlePlayed - a.wordlePlayed;
                }
                if (activeGame === 'connections') {
                    if (b.connectionsWinRate !== a.connectionsWinRate) return b.connectionsWinRate - a.connectionsWinRate;
                    return b.connectionsPlayed - a.connectionsPlayed;
                }
                if (activeGame === 'trivia') {
                    // Best score first, then average, then played
                    if (b.triviaBest !== a.triviaBest) return b.triviaBest - a.triviaBest;
                    if (b.triviaAvg !== a.triviaAvg) return b.triviaAvg - a.triviaAvg;
                    return b.triviaPlayed - a.triviaPlayed;
                }
                // overall
                if (b.overallScore !== a.overallScore) return b.overallScore - a.overallScore;
                return (b.wordlePlayed + b.connectionsPlayed + b.triviaPlayed) - (a.wordlePlayed + a.connectionsPlayed + a.triviaPlayed);
            });

            const metricFor = (p) => {
                if (activeGame === 'wordle') return { value: `${p.wordleWinRate}%`, label: 'Win rate' };
                if (activeGame === 'connections') return { value: `${p.connectionsWinRate}%`, label: 'Win rate' };
                if (activeGame === 'trivia') return { value: `${p.triviaBest}/10`, label: 'Best' };
                return { value: `${p.overallScore}%`, label: 'Overall' };
            };

            if (loading) {
                return (
                    <div className="game-container">
                        <div className="loading">
                            <div className="spinner"></div>
                            <p>Loading leaderboard...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="game-container">
                    <div className="game-header">
                        <h2 className="game-title">Global Leaderboard</h2>
                        <p className="game-subtitle">See who tops each game</p>
                    </div>

                    <div style={{display:'flex', gap:'8px', justifyContent:'center', flexWrap:'wrap', marginBottom:'16px'}}>
                        <button className={`button button-secondary ${activeGame==='wordle' ? 'active-pill' : ''}`} onClick={() => setActiveGame('wordle')}>Wordle</button>
                        <button className={`button button-secondary ${activeGame==='connections' ? 'active-pill' : ''}`} onClick={() => setActiveGame('connections')}>Connections</button>
                        <button className={`button button-secondary ${activeGame==='trivia' ? 'active-pill' : ''}`} onClick={() => setActiveGame('trivia')}>Trivia</button>
                        <button className={`button button-secondary ${activeGame==='overall' ? 'active-pill' : ''}`} onClick={() => setActiveGame('overall')}>Overall</button>
                    </div>

                    {sorted.map((player, i) => {
                        const isCurrentUser = user && player.uid === user.uid;
                        const metric = metricFor(player);

                        return (
                            <div key={player.uid} className={`leaderboard-entry ${isCurrentUser ? 'me' : ''}`}>
                                <div className="leaderboard-left">
                                    <div className="rank">#{i + 1}</div>
                                    {player.photoURL ? (
                                        <img src={player.photoURL} alt={player.displayName} className="avatar" />
                                    ) : (
                                        <div className="avatar"></div>
                                    )}
                                    <div className="player-info">
                                        <h4>{player.displayName}{isCurrentUser && ' (You)'}</h4>
                                        <p>
                                            {activeGame === 'trivia'
                                                ? `Avg: ${player.triviaAvg}%`
                                                : `Played: ${activeGame === 'wordle' ? player.wordlePlayed : activeGame === 'connections' ? player.connectionsPlayed : (player.wordlePlayed + player.connectionsPlayed + player.triviaPlayed)}`
                                            }
                                        </p>
                                    </div>
                                </div>
                                <div className="streak-info">
                                    <div className="streak-value">{metric.value}</div>
                                    <div className="streak-label">{metric.label}</div>
                                </div>
                            </div>
                        );
                    })}

                    {sorted.length === 0 && (
                        <div style={{textAlign: 'center', padding: '40px', color: '#666'}}>
                            <p>No players yet. Be the first!</p>
                        </div>
                    )}
                </div>
            );
        }

        // Render App
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
